name: Tests

on:
  push:
    branches:
      - 'main'
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches:
      - 'main'

permissions:
  id-token: write
  contents: read

env:
  TENSORLAKE_API_URL: http://localhost:8900

jobs:
  run_tests:
    name: Lint and test
    runs-on: ubuntu-latest-xlarge
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: "pip"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 2.0.0
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Build and lint tensorlake
        run: make build && make check

      - name: Set up Docker
        uses: docker/setup-docker-action@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-platform-api
          aws-region: ${{ vars.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Start Background Indexify Server in Docker container
        uses: JarvusInnovations/background-action@v1
        with:
          # Indexify Server storage path has to be that same in container and host
          # so Executor can use local FS BLOB store.
          run: |
            mkdir -p /tmp/indexify-server-storage/indexify_storage/blobs
            docker run -i -a stdout -a stderr --rm \
              -p 127.0.0.1:8900:8900/tcp \
              -p 127.0.0.1:8901:8901/tcp \
              --name indexify-server \
              -v /tmp/indexify-server-storage:/tmp/indexify-server-storage \
              -w /tmp/indexify-server-storage \
              ${{ steps.login-ecr.outputs.registry }}/indexify-server:latest  &
          wait-on: |
            tcp:localhost:8900
          tail: true
          wait-for: 30s
          log-output: true
          # always logging the output to debug test failures.
          log-output-if: true

      - name: Install Indexify from PyPI
        run: pip install indexify
      - name: Install Tensorlake from local source
        run: pip install -e . && pip show tensorlake
      - name: Install dependencies of integration tests globally
        run: |
          pip install "parameterized>=0.9.0"
          pip install "psutil>=7.0.0"
      - name: Start Background Indexify Executor
        uses: JarvusInnovations/background-action@v1
        with:
          run: |
            indexify-cli executor --dev &
            echo $! > /tmp/executor.pid &

          wait-on: |
            tcp:localhost:8900

          tail: true
          wait-for: 10s
          log-output: true
          # always logging the output to debug test failures.
          log-output-if: true

      - name: Wait for readiness
        run: |
          serverReady=false
          counter=0
          while [ "$serverReady" != true ]; do
            output=$(curl --silent --fail http://localhost:8900/internal/executors | jq '. | length' 2>/dev/null)
            if [[ $? -eq 0 && "$output" -ge 1 ]]; then
                echo "Server ready with executors."
                serverReady=true
            else
                echo 'Waiting for executors to join server...'
                counter=$((counter+1))
                if [ $counter -gt 6 ]; then
                    echo "Timeout waiting for executors to join server."
                    exit 1
                fi
                sleep 5
            fi
          done

      - name: Run tests
        env:
          TENSORLAKE_API_URL: http://127.0.0.1:8900
        run: make test

  test_sandbox:
    name: Sandbox integration tests
    runs-on: ubuntu-latest-xlarge
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: "pip"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 2.0.0
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Build tensorlake
        run: make build

      - name: Set up Docker
        uses: docker/setup-docker-action@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-sandbox-tests
          aws-region: ${{ vars.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Install Indexify Dataplane
        run: |
          docker pull ${{ steps.login-ecr.outputs.registry }}/indexify-dataplane:latest
          container_id=$(docker create ${{ steps.login-ecr.outputs.registry }}/indexify-dataplane:latest)
          docker cp $container_id:/indexify/indexify-dataplane /usr/local/bin/indexify-dataplane
          docker rm $container_id
          chmod +x /usr/local/bin/indexify-dataplane

      - name: Start Indexify Server
        run: |
          docker run -d \
            -p 127.0.0.1:8900:8900/tcp \
            -p 127.0.0.1:8901:8901/tcp \
            --name indexify-server \
            ${{ steps.login-ecr.outputs.registry }}/indexify-server:latest

          # Wait for server to be ready
          timeout 30 bash -c 'until curl -sf http://127.0.0.1:8900/ >/dev/null 2>&1; do sleep 0.5; done'
          echo "Indexify server is ready"

      - name: Start Indexify Dataplane
        run: |
          mkdir -p /tmp/dataplane
          cat > /tmp/dataplane/config.yaml <<'YAML'
          env: local
          server_addr: "http://localhost:8901"
          driver:
            type: docker
          http_proxy:
            port: 8902
            listen_addr: "0.0.0.0"
            advertise_address: "127.0.0.1:8902"
          monitoring:
            port: 8903
          state_file: "/tmp/dataplane/state.json"
          YAML
          nohup /usr/local/bin/indexify-dataplane --config /tmp/dataplane/config.yaml \
            > /tmp/dataplane.log 2>&1 &
          echo $! > /tmp/dataplane.pid

          # Wait for dataplane to be ready
          timeout 30 bash -c 'until curl -sf http://127.0.0.1:8903/ >/dev/null 2>&1; do sleep 0.5; done' || \
            timeout 30 bash -c 'until ss -tln | grep -q :8902; do sleep 0.5; done'
          echo "Indexify dataplane is ready"

      - name: Verify infrastructure health
        run: |
          echo "=== Server health ==="
          curl -sf http://127.0.0.1:8900/internal/executors | head -c 500
          echo ""
          echo "=== Dataplane process ==="
          pgrep -fa indexify-dataplane || echo "WARNING: dataplane process not found!"
          echo ""
          echo "=== Dataplane HTTP proxy ==="
          curl -sf http://127.0.0.1:8902/ || echo "(expected error, port is open)"
          echo ""
          echo "=== Docker containers ==="
          docker ps --format 'table {{.ID}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}'
          echo ""
          echo "=== Dataplane log so far ==="
          cat /tmp/dataplane.log 2>/dev/null | head -50 || echo "No dataplane logs yet"

      - name: Run Sandbox integration tests
        env:
          TENSORLAKE_API_URL: http://127.0.0.1:8900
        run: |
          set -o pipefail
          make test_sandbox 2>&1 | tee /tmp/sandbox-tests.log

      - name: Dump logs on failure
        if: failure()
        run: |
          echo "=== Server container status ==="
          docker inspect indexify-server --format='ExitCode={{.State.ExitCode}} OOMKilled={{.State.OOMKilled}} Status={{.State.Status}}' 2>/dev/null || echo "Container already removed"
          echo ""
          echo "=== Dataplane process status ==="
          pgrep -fa indexify-dataplane || echo "WARNING: dataplane process not found!"
          echo ""
          echo "=== Docker containers at failure ==="
          docker ps -a --format 'table {{.ID}}\t{{.Image}}\t{{.Status}}\t{{.Names}}'
          echo ""
          echo "=== Network connections to server ==="
          ss -tnp 'sport = :8900 or dport = :8900' 2>/dev/null || netstat -tnp 2>/dev/null | grep 8900 || true
          echo ""
          echo "=== Server logs (last 100 lines) ==="
          docker logs --tail 100 indexify-server 2>&1 || echo "No server logs available"
          echo ""
          echo "=== Full dataplane logs ==="
          cat /tmp/dataplane.log 2>/dev/null || echo "No dataplane logs available"
          echo ""
          echo "=== Sandbox test logs ==="
          cat /tmp/sandbox-tests.log 2>/dev/null || echo "No test logs available"
          echo ""
          echo "=== dmesg OOM check ==="
          sudo dmesg | grep -i "oom\|killed process" | tail -20 || true
